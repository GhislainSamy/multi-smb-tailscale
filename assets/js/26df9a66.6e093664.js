"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[719],{6041:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/plex-smb-diagram-5ce55874d31332b3aec52063aa12d1f9.png"},6842:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"proxmox/networking/multi-smb-tailscale","title":"Proxmox Multi-SMB via Tailscale","description":"Contexte","source":"@site/docs/proxmox/networking/multi-smb-tailscale.md","sourceDirName":"proxmox/networking","slug":"/proxmox/networking/multi-smb-tailscale","permalink":"/multi-smb-tailscale/proxmox/networking/multi-smb-tailscale","draft":false,"unlisted":false,"editUrl":"https://github.com/GhislainSamy/multi-smb-tailscale/docs/proxmox/networking/multi-smb-tailscale.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Installation du conteneur LXC Tailscale","permalink":"/multi-smb-tailscale/proxmox/lxc/tailscale-installation"},"next":{"title":"Limitation de la bande passante SMB via Tailscale (Debian 12)","permalink":"/multi-smb-tailscale/proxmox/networking/bandwidth-limitation"}}');var r=i(4848),t=i(8453);const l={},a="Proxmox Multi-SMB via Tailscale",c={},o=[{value:"Contexte",id:"contexte",level:2},{value:"Sch\xe9ma d&#39;architecture",id:"sch\xe9ma-darchitecture",level:2},{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"Configuration initiale",id:"configuration-initiale",level:2},{value:"Cr\xe9er un compte chez Tailscale",id:"cr\xe9er-un-compte-chez-tailscale",level:3},{value:"Installer Tailscale LXC (Advertising)",id:"installer-tailscale-lxc-advertising",level:3},{value:"Configuration Access Control",id:"configuration-access-control",level:3},{value:"Installation Tailscale LXC (Contrib2)",id:"installation-tailscale-lxc-contrib2",level:2},{value:"Service systemd pour client Tailscale",id:"service-systemd-pour-client-tailscale",level:3},{value:"1\ufe0f\u20e3 Cr\xe9er le fichier de service",id:"1\ufe0f\u20e3-cr\xe9er-le-fichier-de-service",level:4},{value:"2\ufe0f\u20e3 Ajouter le contenu suivant",id:"2\ufe0f\u20e3-ajouter-le-contenu-suivant",level:4},{value:"3\ufe0f\u20e3 Recharger systemd et activer le service",id:"3\ufe0f\u20e3-recharger-systemd-et-activer-le-service",level:4},{value:"4\ufe0f\u20e3 V\xe9rifier que \xe7a fonctionne",id:"4\ufe0f\u20e3-v\xe9rifier-que-\xe7a-fonctionne",level:4},{value:"Configuration montage SMB",id:"configuration-montage-smb",level:2},{value:"Cr\xe9er la liaison de montage (Tailscale LXC \u2192 Plex LXC)",id:"cr\xe9er-la-liaison-de-montage-tailscale-lxc--plex-lxc",level:3},{value:"Configuration des mount points",id:"configuration-des-mount-points",level:3},{value:"Sur le conteneur Plex LXC",id:"sur-le-conteneur-plex-lxc",level:4},{value:"Sur le conteneur Tailscale LXC (Contrib2)",id:"sur-le-conteneur-tailscale-lxc-contrib2",level:4},{value:"Configuration SMB",id:"configuration-smb",level:3},{value:"Cr\xe9er les credentials SMB",id:"cr\xe9er-les-credentials-smb",level:4},{value:"Configuration fstab",id:"configuration-fstab",level:4},{value:"Test de montage",id:"test-de-montage",level:4},{value:"Gestion du red\xe9marrage",id:"gestion-du-red\xe9marrage",level:2},{value:"1\ufe0f\u20e3 Cr\xe9er le script d&#39;attente + montage",id:"1\ufe0f\u20e3-cr\xe9er-le-script-dattente--montage",level:3},{value:"2\ufe0f\u20e3 Cr\xe9er le service systemd",id:"2\ufe0f\u20e3-cr\xe9er-le-service-systemd",level:3},{value:"3\ufe0f\u20e3 Activer et d\xe9marrer le service",id:"3\ufe0f\u20e3-activer-et-d\xe9marrer-le-service",level:3},{value:"Configuration Plex",id:"configuration-plex",level:2},{value:"\xc9tapes suivantes",id:"\xe9tapes-suivantes",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"proxmox-multi-smb-via-tailscale",children:"Proxmox Multi-SMB via Tailscale"})}),"\n",(0,r.jsx)(n.h2,{id:"contexte",children:"Contexte"}),"\n",(0,r.jsx)(n.p,{children:"L'objectif est de partager le dossier des m\xe9dias via SMB en passant par le tunnel Tailscale. Ainsi, Plex peut lire les fichiers directement et proposer d'immenses biblioth\xe8ques de contenu sans duplication, ce qui permet d'\xe9conomiser beaucoup d'espace de stockage."}),"\n",(0,r.jsx)(n.admonition,{title:"Cas d'usage",type:"info",children:(0,r.jsx)(n.p,{children:"Le syst\xe8me prend tout son sens lorsque plusieurs personnes participent au partage : chacun peut contribuer avec ses propres fichiers, et l'ensemble est rendu accessible \xe0 tous de mani\xe8re transparente."})}),"\n",(0,r.jsx)(n.h2,{id:"sch\xe9ma-darchitecture",children:"Sch\xe9ma d'architecture"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Sch\xe9ma Plex SMB",src:i(6041).A+"",width:"597",height:"333"})}),"\n",(0,r.jsx)(n.h2,{id:"pr\xe9requis",children:"Pr\xe9requis"}),"\n",(0,r.jsx)(n.admonition,{title:"V\xe9rifications importantes",type:"warning",children:(0,r.jsx)(n.p,{children:"Avant de commencer, assurez-vous d'avoir :"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"1 conteneur LXC Tailscale (advertising)"})," : d\xe9di\xe9 exclusivement \xe0 la publication du subnet"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"1 conteneur LXC Tailscale (Contrib2)"}),": utilis\xe9 uniquement pour se connecter au tailnet du deuxi\xe8me contributeur"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"1 conteneur LXC Plex"})," : disposera, via des points de montage depuis l'h\xf4te, d'un acc\xe8s \xe0 plusieurs partages SMB"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration-initiale",children:"Configuration initiale"}),"\n",(0,r.jsx)(n.h3,{id:"cr\xe9er-un-compte-chez-tailscale",children:"Cr\xe9er un compte chez Tailscale"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Rendez-vous sur ",(0,r.jsx)(n.a,{href:"https://tailscale.com",children:"Tailscale"})]}),"\n",(0,r.jsx)(n.li,{children:"Cr\xe9ez votre compte"}),"\n",(0,r.jsx)(n.li,{children:"Notez votre tailnet name"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"installer-tailscale-lxc-advertising",children:"Installer Tailscale LXC (Advertising)"}),"\n",(0,r.jsx)(n.admonition,{title:"R\xe9f\xe9rence",type:"tip",children:(0,r.jsxs)(n.p,{children:["Suivez le guide : ",(0,r.jsx)(n.a,{href:"../../lxc/tailscale-installation",children:"Installer le conteneur LXC Tailscale"})]})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-access-control",children:"Configuration Access Control"}),"\n",(0,r.jsxs)(n.p,{children:["Allez dans Access Control puis ajouter le droit SMB :\r\n",(0,r.jsx)(n.a,{href:"https://login.tailscale.com/admin/acls/file",children:"https://login.tailscale.com/admin/acls/file"})]}),"\n",(0,r.jsx)(n.p,{children:"Choisir le format JSON, voici un exemple :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",metastring:'title="ACL Configuration"',children:'{\r\n  "ACLs": [\r\n    {\r\n      "Action": "accept",\r\n      "Users": [\r\n        "contributeur2@gmail.com"\r\n      ],\r\n      "Ports": [\r\n        "192.168.x.x:139",\r\n        "192.168.x.x:445"\r\n      ]\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"installation-tailscale-lxc-contrib2",children:"Installation Tailscale LXC (Contrib2)"}),"\n",(0,r.jsx)(n.admonition,{title:"Note importante",type:"info",children:(0,r.jsxs)(n.p,{children:["Pas besoin d'advertising pour ce conteneur, la commande sera simplement ",(0,r.jsx)(n.code,{children:"tailscale up"})]})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./lxc/tailscale-installation",children:"Installer le conteneur LXC Tailscale"})}),"\n",(0,r.jsxs)(n.li,{children:["Lors de la connexion avec le lien, ",(0,r.jsx)(n.strong,{children:"mettre votre mail mais choisir le tailnet de contrib2"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"service-systemd-pour-client-tailscale",children:"Service systemd pour client Tailscale"}),"\n",(0,r.jsx)(n.p,{children:"Pour automatiser le d\xe9marrage, cr\xe9ons un service systemd :"}),"\n",(0,r.jsx)(n.h4,{id:"1\ufe0f\u20e3-cr\xe9er-le-fichier-de-service",children:"1\ufe0f\u20e3 Cr\xe9er le fichier de service"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano /etc/systemd/system/tailscale-accept-routes.service\n"})}),"\n",(0,r.jsx)(n.h4,{id:"2\ufe0f\u20e3-ajouter-le-contenu-suivant",children:"2\ufe0f\u20e3 Ajouter le contenu suivant"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",metastring:'title="/etc/systemd/system/tailscale-accept-routes.service"',children:"[Unit]\r\nDescription=Tailscale client with subnet routes enabled\r\nAfter=network-online.target\r\nWants=network-online.target\r\n\r\n[Service]\r\nType=oneshot\r\nExecStart=/usr/bin/tailscale up --accept-routes=true\r\nRemainAfterExit=yes\r\n\r\n[Install]\r\nWantedBy=multi-user.target\n"})}),"\n",(0,r.jsx)(n.h4,{id:"3\ufe0f\u20e3-recharger-systemd-et-activer-le-service",children:"3\ufe0f\u20e3 Recharger systemd et activer le service"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl daemon-reload\r\nsystemctl enable tailscale-accept-routes.service\r\nsystemctl start tailscale-accept-routes.service\n"})}),"\n",(0,r.jsx)(n.h4,{id:"4\ufe0f\u20e3-v\xe9rifier-que-\xe7a-fonctionne",children:"4\ufe0f\u20e3 V\xe9rifier que \xe7a fonctionne"}),"\n",(0,r.jsx)(n.p,{children:"V\xe9rifie le statut du service :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl status tailscale-accept-routes.service\n"})}),"\n",(0,r.jsx)(n.p,{children:"V\xe9rifie que les routes Tailscale sont bien accept\xe9es :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"tailscale status\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration-montage-smb",children:"Configuration montage SMB"}),"\n",(0,r.jsx)(n.h3,{id:"cr\xe9er-la-liaison-de-montage-tailscale-lxc--plex-lxc",children:"Cr\xe9er la liaison de montage (Tailscale LXC \u2192 Plex LXC)"}),"\n",(0,r.jsx)(n.p,{children:"Sur l'h\xf4te Proxmox :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mkdir /mnt/smb_contributeur2\n"})}),"\n",(0,r.jsx)(n.p,{children:"Donner les droits au conteneur Tailscale LXC Contrib2 :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"chown -R 100000:100000 /mnt/smb_contributeur2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-des-mount-points",children:"Configuration des mount points"}),"\n",(0,r.jsx)(n.h4,{id:"sur-le-conteneur-plex-lxc",children:"Sur le conteneur Plex LXC"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vi /etc/pve/lxc/plex-lxc.conf\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ajouter :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"mp1: /mnt/smb_contributeur2,mp=/mnt/smb_contributeur2\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"mp1 car mp0 est d\xe9j\xe0 utilis\xe9 pour le NAS"})}),"\n",(0,r.jsx)(n.h4,{id:"sur-le-conteneur-tailscale-lxc-contrib2",children:"Sur le conteneur Tailscale LXC (Contrib2)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vi /etc/pve/lxc/tailscale-contrib2-lxc.conf\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ajouter :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",children:"mp0: /mnt/smb_contributeur2,mp=/mnt/smb_contributeur2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-smb",children:"Configuration SMB"}),"\n",(0,r.jsx)(n.h4,{id:"cr\xe9er-les-credentials-smb",children:"Cr\xe9er les credentials SMB"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vi /root/.smbcredentials\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",metastring:'title="/root/.smbcredentials"',children:"username=compte-smb-pour-contributeur1\r\npassword=super-mdp\n"})}),"\n",(0,r.jsx)(n.p,{children:"S\xe9curiser le fichier :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"chmod 600 /root/.smbcredentials\n"})}),"\n",(0,r.jsx)(n.h4,{id:"configuration-fstab",children:"Configuration fstab"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nano /etc/fstab\n"})}),"\n",(0,r.jsx)(n.p,{children:"Ajouter la ligne de montage SMB :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/fstab"',children:"//192.168.x.x/medias /mnt/smb_contributeur2 cifs credentials=/root/.smbcredentials,uid=100000,gid=100000,_netdev,iocharset=utf8,vers=3.0 0 0\n"})}),"\n",(0,r.jsx)(n.h4,{id:"test-de-montage",children:"Test de montage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"mount -a\r\ncd /mnt/smb_contributeur2\r\nls\n"})}),"\n",(0,r.jsx)(n.p,{children:"Test depuis l'h\xf4te Proxmox :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd /mnt/smb_contributeur2\r\nls\n"})}),"\n",(0,r.jsx)(n.h2,{id:"gestion-du-red\xe9marrage",children:"Gestion du red\xe9marrage"}),"\n",(0,r.jsx)(n.admonition,{title:"Probl\xe8me de timing",type:"warning",children:(0,r.jsx)(n.p,{children:"Si le conteneur red\xe9marre, le montage SMB peut \xe9chouer car Tailscale n'est pas encore connect\xe9."})}),"\n",(0,r.jsx)(n.h3,{id:"1\ufe0f\u20e3-cr\xe9er-le-script-dattente--montage",children:"1\ufe0f\u20e3 Cr\xe9er le script d'attente + montage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo nano /usr/local/bin/mount-smb-after-tailscale.sh\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",metastring:'title="/usr/local/bin/mount-smb-after-tailscale.sh"',children:'#!/bin/bash\r\n\r\n# Boucle jusqu\'\xe0 ce que Tailscale ait une IP 100.x\r\nwhile ! tailscale status | grep -q "100\\."; do\r\n    echo "Waiting for Tailscale to connect..."\r\n    sleep 2\r\ndone\r\n\r\n# Monter le SMB\r\nmount -a\n'})}),"\n",(0,r.jsx)(n.p,{children:"Rendre le script ex\xe9cutable :"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo chmod +x /usr/local/bin/mount-smb-after-tailscale.sh\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\ufe0f\u20e3-cr\xe9er-le-service-systemd",children:"2\ufe0f\u20e3 Cr\xe9er le service systemd"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo nano /etc/systemd/system/mount-smb-after-tailscale.service\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ini",metastring:'title="/etc/systemd/system/mount-smb-after-tailscale.service"',children:"[Unit]\r\nDescription=Mount SMB share after Tailscale connection\r\nAfter=tailscaled.service network-online.target\r\nRequires=tailscaled.service\r\n\r\n[Service]\r\nType=oneshot\r\nExecStart=/usr/local/bin/mount-smb-after-tailscale.sh\r\nRemainAfterExit=yes\r\n\r\n[Install]\r\nWantedBy=multi-user.target\n"})}),"\n",(0,r.jsx)(n.h3,{id:"3\ufe0f\u20e3-activer-et-d\xe9marrer-le-service",children:"3\ufe0f\u20e3 Activer et d\xe9marrer le service"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl daemon-reload\r\nsudo systemctl enable mount-smb-after-tailscale.service\r\nsudo systemctl start mount-smb-after-tailscale.service\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"Test final",type:"success",children:(0,r.jsx)(n.p,{children:"Red\xe9marrer le conteneur pour valider le bon fonctionnement"})}),"\n",(0,r.jsx)(n.h2,{id:"configuration-plex",children:"Configuration Plex"}),"\n",(0,r.jsx)(n.p,{children:"Pour finir, ajouter les chemins dans Plex via l'interface web :"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Configuration Plex",src:i(9601).A+"",width:"571",height:"250"})}),"\n",(0,r.jsx)(n.h2,{id:"\xe9tapes-suivantes",children:"\xc9tapes suivantes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./bandwidth-limitation",children:"Limitation de bande passante SMB"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.admonition,{title:"Aide",type:"tip",children:(0,r.jsxs)(n.p,{children:["Pour toute question, ouvrez une issue sur ",(0,r.jsx)(n.a,{href:"https://github.com/GhislainSamy/multi-smb-tailscale/issues",children:"GitHub"}),"."]})})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>a});var s=i(6540);const r={},t=s.createContext(r);function l(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(t.Provider,{value:n},e.children)}},9601:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/plex-config-5699a2d0c255d4e87496c161e8dd60cc.png"}}]);