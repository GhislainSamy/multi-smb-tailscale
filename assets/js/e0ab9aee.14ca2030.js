"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[869],{8453:(e,i,s)=>{s.d(i,{R:()=>t,x:()=>a});var n=s(6540);const r={},l=n.createContext(r);function t(e){const i=n.useContext(l);return n.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function a(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),n.createElement(l.Provider,{value:i},e.children)}},8807:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"proxmox/networking/bandwidth-limitation","title":"Limitation de la bande passante SMB via Tailscale (Debian 12)","description":"Pr\xe9requis","source":"@site/docs/proxmox/networking/bandwidth-limitation.md","sourceDirName":"proxmox/networking","slug":"/proxmox/networking/bandwidth-limitation","permalink":"/multi-smb-tailscale/proxmox/networking/bandwidth-limitation","draft":false,"unlisted":false,"editUrl":"https://github.com/GhislainSamy/multi-smb-tailscale/docs/proxmox/networking/bandwidth-limitation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Proxmox Multi-SMB via Tailscale","permalink":"/multi-smb-tailscale/proxmox/networking/multi-smb-tailscale"}}');var r=s(4848),l=s(8453);const t={},a="Limitation de la bande passante SMB via Tailscale (Debian 12)",c={},d=[{value:"Pr\xe9requis",id:"pr\xe9requis",level:2},{value:"1. Cr\xe9er le script de limitation SMB globale",id:"1-cr\xe9er-le-script-de-limitation-smb-globale",level:2},{value:"2. Rendre le script ex\xe9cutable",id:"2-rendre-le-script-ex\xe9cutable",level:2},{value:"3. Cr\xe9er un service systemd",id:"3-cr\xe9er-un-service-systemd",level:2},{value:"4. Activer et d\xe9marrer le service",id:"4-activer-et-d\xe9marrer-le-service",level:2},{value:"5. V\xe9rifier que la limitation fonctionne",id:"5-v\xe9rifier-que-la-limitation-fonctionne",level:2},{value:"6. Tester la bande passante",id:"6-tester-la-bande-passante",level:2},{value:"Test sur Linux",id:"test-sur-linux",level:3},{value:"Test sur Windows",id:"test-sur-windows",level:3},{value:"Surveillance en temps r\xe9el",id:"surveillance-en-temps-r\xe9el",level:3},{value:"Astuces de configuration",id:"astuces-de-configuration",level:2},{value:"Modifier la limite",id:"modifier-la-limite",level:3},{value:"Surveillance continue",id:"surveillance-continue",level:3},{value:"Supprimer la limitation",id:"supprimer-la-limitation",level:3},{value:"Param\xe8tres avanc\xe9s",id:"param\xe8tres-avanc\xe9s",level:2},{value:"Ajuster les limites par utilisateur",id:"ajuster-les-limites-par-utilisateur",level:3},{value:"Exemples de limites courantes",id:"exemples-de-limites-courantes",level:3}];function o(e){const i={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.header,{children:(0,r.jsx)(i.h1,{id:"limitation-de-la-bande-passante-smb-via-tailscale-debian-12",children:"Limitation de la bande passante SMB via Tailscale (Debian 12)"})}),"\n",(0,r.jsx)(i.h2,{id:"pr\xe9requis",children:"Pr\xe9requis"}),"\n",(0,r.jsx)(i.admonition,{title:"V\xe9rifications",type:"warning",children:(0,r.jsx)(i.p,{children:"Avant de commencer, assurez-vous d'avoir :"})}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsx)(i.li,{children:"Conteneur Debian 12 avec Tailscale install\xe9 et connect\xe9 au tailnet"}),"\n",(0,r.jsxs)(i.li,{children:["Droits ",(0,r.jsx)(i.code,{children:"root"})," ou ",(0,r.jsx)(i.code,{children:"sudo"})," dans le conteneur"]}),"\n",(0,r.jsx)(i.li,{children:"SMB (ports 139 et 445) en service sur le conteneur"}),"\n"]}),"\n",(0,r.jsx)(i.h2,{id:"1-cr\xe9er-le-script-de-limitation-smb-globale",children:"1. Cr\xe9er le script de limitation SMB globale"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo nano /usr/local/bin/limit_smb_global.sh\n"})}),"\n",(0,r.jsx)(i.p,{children:"Contenu du script :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",metastring:'title="/usr/local/bin/limit_smb_global.sh"',children:'#!/bin/bash\r\n\r\n# === VARIABLES ===\r\nTAILSCALE_IF="tailscale0"       # Interface Tailscale\r\nSMB_PORTS=(139 445)             # Ports SMB \xe0 limiter\r\nBANDWIDTH_LIMIT="5mbit"         # Limite globale de bande passante pour SMB\r\n\r\n# === SUPPRESSION DES ANCIENNES R\xc8GLES ===\r\ntc qdisc del dev $TAILSCALE_IF root 2>/dev/null\r\n\r\n# === CR\xc9ATION DE LA RACINE HTB ===\r\ntc qdisc add dev $TAILSCALE_IF root handle 1: htb default 10\r\ntc class add dev $TAILSCALE_IF parent 1: classid 1:1 htb rate 100mbit\r\n\r\n# === CLASSE LIMIT\xc9E POUR SMB ===\r\ntc class add dev $TAILSCALE_IF parent 1:1 classid 1:10 htb rate $BANDWIDTH_LIMIT ceil $BANDWIDTH_LIMIT\r\n\r\n# === FILTRAGE DES PORTS SMB POUR TOUS ===\r\nprio=1\r\nfor port in "${SMB_PORTS[@]}"; do\r\n    tc filter add dev $TAILSCALE_IF protocol ip parent 1:0 prio $prio u32 \\\r\n        match ip dport $port 0xffff flowid 1:10\r\n    ((prio++))\r\ndone\r\n\r\necho "Limite SMB globale appliqu\xe9e : ${BANDWIDTH_LIMIT} sur ports ${SMB_PORTS[*]}"\n'})}),"\n",(0,r.jsx)(i.h2,{id:"2-rendre-le-script-ex\xe9cutable",children:"2. Rendre le script ex\xe9cutable"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo chmod +x /usr/local/bin/limit_smb_global.sh\n"})}),"\n",(0,r.jsx)(i.h2,{id:"3-cr\xe9er-un-service-systemd",children:"3. Cr\xe9er un service systemd"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo nano /etc/systemd/system/limit-smb.service\n"})}),"\n",(0,r.jsx)(i.p,{children:"Contenu du service :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-ini",metastring:'title="/etc/systemd/system/limit-smb.service"',children:"[Unit]\r\nDescription=Limiter la bande passante SMB via Tailscale\r\nAfter=network-online.target\r\nWants=network-online.target\r\n\r\n[Service]\r\nType=oneshot\r\nExecStart=/usr/local/bin/limit_smb_global.sh\r\nRemainAfterExit=yes\r\n\r\n[Install]\r\nWantedBy=multi-user.target\n"})}),"\n",(0,r.jsx)(i.h2,{id:"4-activer-et-d\xe9marrer-le-service",children:"4. Activer et d\xe9marrer le service"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo systemctl daemon-reload\r\nsudo systemctl enable limit-smb.service\r\nsudo systemctl start limit-smb.service\n"})}),"\n",(0,r.jsx)(i.h2,{id:"5-v\xe9rifier-que-la-limitation-fonctionne",children:"5. V\xe9rifier que la limitation fonctionne"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"systemctl status limit-smb.service\r\ntc -s qdisc show dev tailscale0\r\ntc -s class show dev tailscale0\n"})}),"\n",(0,r.jsx)(i.admonition,{title:"Limitation active",type:"success",children:(0,r.jsxs)(i.p,{children:["La limitation SMB doit maintenant \xeatre ",(0,r.jsx)(i.strong,{children:"active imm\xe9diatement"})," et ",(0,r.jsx)(i.strong,{children:"persistante au reboot"}),"."]})}),"\n",(0,r.jsx)(i.h2,{id:"6-tester-la-bande-passante",children:"6. Tester la bande passante"}),"\n",(0,r.jsx)(i.h3,{id:"test-sur-linux",children:"Test sur Linux"}),"\n",(0,r.jsx)(i.p,{children:"Depuis un client Tailscale, copier un gros fichier sur le serveur SMB :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"# Monter le partage SMB\r\nsudo mount -t cifs //100.x.x.x/partage /mnt/smb -o username=user,password=pass\r\n\r\n# Tester le d\xe9bit\r\ndd if=/dev/zero of=/mnt/smb/testfile bs=10M count=50\n"})}),"\n",(0,r.jsx)(i.h3,{id:"test-sur-windows",children:"Test sur Windows"}),"\n",(0,r.jsxs)(i.ol,{children:["\n",(0,r.jsx)(i.li,{children:"Copier un gros fichier via le partage SMB"}),"\n",(0,r.jsx)(i.li,{children:"Observer la vitesse de transfert"}),"\n"]}),"\n",(0,r.jsx)(i.h3,{id:"surveillance-en-temps-r\xe9el",children:"Surveillance en temps r\xe9el"}),"\n",(0,r.jsx)(i.p,{children:"Sur le serveur, v\xe9rifier le d\xe9bit avec :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo iftop -i tailscale0\n"})}),"\n",(0,r.jsx)(i.admonition,{title:"R\xe9sultat attendu",type:"info",children:(0,r.jsxs)(i.p,{children:["Le d\xe9bit sur les ports 139 et 445 devrait se stabiliser autour de la limite d\xe9finie (",(0,r.jsx)(i.code,{children:"BANDWIDTH_LIMIT"}),")."]})}),"\n",(0,r.jsx)(i.h2,{id:"astuces-de-configuration",children:"Astuces de configuration"}),"\n",(0,r.jsx)(i.h3,{id:"modifier-la-limite",children:"Modifier la limite"}),"\n",(0,r.jsxs)(i.p,{children:["Pour changer la limite de bande passante, \xe9diter la variable ",(0,r.jsx)(i.code,{children:"BANDWIDTH_LIMIT"})," dans ",(0,r.jsx)(i.code,{children:"/usr/local/bin/limit_smb_global.sh"})," et relancer le service :"]}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo systemctl restart limit-smb.service\n"})}),"\n",(0,r.jsx)(i.h3,{id:"surveillance-continue",children:"Surveillance continue"}),"\n",(0,r.jsx)(i.p,{children:"Pour v\xe9rifier les classes et le trafic en temps r\xe9el :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"tc -s class show dev tailscale0\r\ntc -s qdisc show dev tailscale0\n"})}),"\n",(0,r.jsx)(i.h3,{id:"supprimer-la-limitation",children:"Supprimer la limitation"}),"\n",(0,r.jsx)(i.p,{children:"Pour d\xe9sactiver compl\xe8tement la limitation :"}),"\n",(0,r.jsx)(i.pre,{children:(0,r.jsx)(i.code,{className:"language-bash",children:"sudo systemctl stop limit-smb.service\r\nsudo systemctl disable limit-smb.service\r\ntc qdisc del dev tailscale0 root\n"})}),"\n",(0,r.jsx)(i.h2,{id:"param\xe8tres-avanc\xe9s",children:"Param\xe8tres avanc\xe9s"}),"\n",(0,r.jsx)(i.h3,{id:"ajuster-les-limites-par-utilisateur",children:"Ajuster les limites par utilisateur"}),"\n",(0,r.jsx)(i.p,{children:"Pour des limitations plus granulaires, vous pouvez modifier le script pour cr\xe9er des classes s\xe9par\xe9es par adresse IP ou utilisateur."}),"\n",(0,r.jsx)(i.h3,{id:"exemples-de-limites-courantes",children:"Exemples de limites courantes"}),"\n",(0,r.jsxs)(i.ul,{children:["\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Limitation stricte"})," : ",(0,r.jsx)(i.code,{children:"1mbit"})]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Usage normal"})," : ",(0,r.jsx)(i.code,{children:"5mbit"})]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Usage \xe9lev\xe9"})," : ",(0,r.jsx)(i.code,{children:"10mbit"})]}),"\n",(0,r.jsxs)(i.li,{children:[(0,r.jsx)(i.strong,{children:"Pas de limitation"})," : ",(0,r.jsx)(i.code,{children:"100mbit"})]}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,l.R)(),...e.components};return i?(0,r.jsx)(i,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);